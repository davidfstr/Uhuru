<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Translation Assistant</title>
    
    <!-- Bootstrap -->
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Panels: Backgrounds */
        #dialogue,
        #kanji-info,
        #word-info {
            background-color: lightgray;
        }
        
        /* Panels: Spacing */
        body {
            margin: 1em;
        }
        #kanji-info {
            margin-bottom: 1em;
        }
        
        /* Panels: Heights & Padding */
        html, body, .container, .row, #dialogue {
            /* Dialogue Panel: Full Height */
            height: 100%;
        }
        #sidebar {
            height: 100%;
        }
        #sidebar #word-info {
            min-height: 500px;
        }
        #dialogue,
        #sidebar #kanji-info,
        #sidebar #word-info {
            padding: 1em;
        }
        
        /* Typography: Dialogue Panel */
        #dialogue {
            font-size: 27px;
        }
        
        /* Typography: Kanji Info Panel */
        #kanji-info {
            font-family: arial;
            font-size: 20px;
            text-align: center;
            color: black;
        }
        #kanji-info #kanji {
            font-family: Hiragino Kaku Gothic Pro, Mincho;
            font-size: 150px;
            line-height: 1.1em
        }
        
        /* Typography: Word Info Panel */
        #word-info {
            font-family: arial;
            font-size: 20px;
            text-align: center;
            color: black;
        }
        #word-info #furigana {
            font-size: 27px;
            margin-top: -.5em;
            margin-bottom: .5em;
        }
        #word-info #word {
            font-size: 60px;
        }
        #word-info #definition {
            font-family: georgia;
            font-size: 16px;
            text-align: left;
        }
        
        #dialogue span.selected {
            background-color: orange;
        }
        /*
        #dialogue span:hover {
            background-color: yellow;
        }
        */
    </style>
    
    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
    <!-- Underscore -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script>
        console.log('Loading RTK database...');
        $.ajax({
            url: 'rtk_db.json',
            dataType: 'json'
        }).done(function(data, textStatus, jqXHR) {
            console.log('RTK database loaded.');
            window.rtkDb = data;
        });
        
        console.log('Loading prefix tree...');
        $.ajax({
            url: 'prefix_tree.json',
            dataType: 'json'
        }).done(function(data, textStatus, jqXHR) {
            console.log('Prefix tree loaded.');
            window.prefixTreeRoot = data;
        });
        
        console.log('Loading EDICT entries...');
        $.ajax({
            url: 'edict_entries.json',
            dataType: 'json'
        }).done(function(data, textStatus, jqXHR) {
            console.log('EDICT entries loaded.');
            window.edictEntries = data;
        });
        
        $(function() {
            // Wrap all dialogue characters in spans to make them hoverable
            var dialogueHtml = $('#dialogue').html().trim();
            dialogueHtml = dialogueHtml.replace(/(.)/g, '<span>$1</span>');
            $('#dialogue').html(dialogueHtml);
            
            function lookupKanjiForDialogueSpan(target) {
                var c = $(target).text();
                var info = window.rtkDb ? window.rtkDb[c] : null;
                if (!info) {
                    info = {'k': '?', 'c': c, 'hn': 0}
                }
                $('#kanji-info #keyword').text(info['k']);
                $('#kanji-info #kanji').text(info['c']);
                $('#kanji-info #nr').text(info['hn']);
                
                return c;
            }
            
            function lookupWordForDialogueSpan(target) {
                // Find the character, and all characters after it
                var characters = [];
                var curSpan = $(target);
                while (curSpan.length > 0) {
                    characters.push(curSpan.text());
                    curSpan = curSpan.next();
                }
                
                // Find longest prefix of 'characters' that is a word
                var matchWord = '';
                var matchEntryIds = ['0'];
                var parent = window.prefixTreeRoot;
                for (var i = 0; i<characters.length; i++) {
                    var c = characters[i];
                    var child = parent[c];
                    if (child) {
                        parent = child;
                        if (parent['@']) {
                            matchWord = characters.slice(0, i + 1).join('');
                            matchEntryIds = parent['@'];
                        }
                    } else {
                        break;
                    }
                }
                
                // Lookup entries
                var matchEntries = _.map(matchEntryIds, function(entryId) {
                    return window.edictEntries[entryId] || {
                        'kanjis': [],
                        'kanas': [],
                        'glosses': [],
                        'id': '0'
                    };
                });
                
                // Update word info box with entry data
                $('#word-info #word').text(matchWord);
                // TODO: Disallow HTML injection
                $('#word-info #furigana').html(formatFuriganaForEntries(matchEntries));
                // TODO: Disallow HTML injection
                $('#word-info #definition').html(_.map(matchEntries, function(entry) {
                    return formatDefinitionForEntry(entry);
                }).join('<hr/>'));
                
                return matchWord;
            }
            
            function formatFuriganaForEntries(entries) {
                // Gather all unique kana
                var allKanas = [];
                _.each(entries, function(entry) {
                    _.each(entry.kanas, function(kana) {
                        if (allKanas.indexOf(kana) !== -1) {
                            allKanas.push(kana);
                        }
                    });
                });
                
                return allKanas.join('、');
            }
            
            function formatDefinitionForEntry(entry) {
                var hasBullets = false;
                _.each(entry.glosses, function(gloss) {
                    if (gloss.indexOf('(1)') !== -1) {
                        hasBullets = true;
                    }
                });
                
                var firstGloss = true;
                var insideBullets = false;
                var outputParts = _.map(entry.glosses, function(gloss) {
                    var groups = gloss.match(/^(.*?)\(([0-9]+)\) (.*)$/);
                    if (groups) {
                        // Found a bullet
                        result = '<b>' + groups[2] + '.</b> ' + groups[1] + groups[3];
                        if (insideBullets) {
                            result = '<br/>' + result; // close previous bullet
                        }
                        
                        insideBullets = true;
                    } else {
                        if (insideBullets) {
                            // Bullet continuation
                            result = '; ' + gloss; 
                        } else {
                            // Before the first bullet
                            if (firstGloss) {
                                result = gloss;
                            } else {
                                result = '; ' + gloss;
                            }
                        }
                    }
                    
                    firstGloss = false;
                    return result;
                });
                return outputParts.join('');
            }
            
            var lastSelectedSpans = [];
            
            // Hover over a dialogue character?
            $('#dialogue span').on('mouseenter', function(e) {
                // Lookup the associated kanji.
                lookupKanjiForDialogueSpan(e.target);
                // Lookup the associated word.
                var word = lookupWordForDialogueSpan(e.target);
                
                // Find new spans to select
                var selectedSpans = [];
                var curSpan = $(e.target);
                for (var i = 0; i < word.length; i++) {
                    selectedSpans.push(curSpan);
                    curSpan = curSpan.next();
                }
                
                // Update selected spans
                _.each(lastSelectedSpans, function(s) {
                    s.removeClass('selected');
                });
                _.each(selectedSpans, function(s) {
                    s.addClass('selected');
                });
                lastSelectedSpans = selectedSpans;
            });
        });
    </script>
</head>
<body>

<div class="container">
    <div class="row">
        <div id="dialogue" class="col-md-8">
            「稲叢さんの料理は、自分で作るよりも美味しいから、凄く助かってる。ありがとう」
        </div>
        <div id="sidebar" class="col-md-4">
            <div id="kanji-info">
                <div id="keyword">person</div>
                <div id="kanji">人</div>
                <div>Nr: <span id="nr">951</span></div>
            </div>
            <div id="word-info">
                <div id="word">大人</div>
                <div id="furigana">おとな</div>
                <div id="definition">
                    <b>1:</b> man of substance or virtue; gentleman;<br/>
                    <b>2:</b> giant
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>